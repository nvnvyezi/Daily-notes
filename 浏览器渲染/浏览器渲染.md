### 问题

- 白屏是什么原因
- js会影响首屏吗
- git为什么会出现html裸奔的情况

### 名词

#### 关键渲染路径

指与当前用户操作有关的内容。例如用户刚刚打开一个页面，首屏的显示就是当前用户操作相关的内容，具体就是浏览器收到 HTML、CSS 和 JavaScript 等资源并对其进行处理从而渲染出 Web 页面。

#### 优化关键渲染路径

优先显示与当前用户操作内容有关的内容

#### reflow

当页面上有一些信息变化时，如大小、位置变化；浏览器可能会需要重新计算元素的展示样式，这个过程称为reflow；

#### rapint

 当元素的位置、大小等属性确定好后，浏览器会把这些元素重新绘制一遍，这个过程称为repaint；

### 浏览器如何渲染页面

在构建页面前首先需要构建DOM树和CSS树

#### 文档对象模型（DOM）

![DOM æå"ºæµç¨](浏览器渲染.assets/full-process.png)

**转换**

浏览器从磁盘或者网络读取HTML的原始字节，并根据文件的指定编码将它们转换成各个字符

**令牌化**

浏览器将字符串根据W3C标准规定的各种令牌进行转换，每个令牌都具有特殊含义和一组规则

**词法分析**

将令牌转换成定义其属性和规则的对象

**DOM构建**

由于 HTML 标记定义不同标记之间的关系（一些标记包含在其他标记内），创建的对象链接在一个树数据结构内，此结构也会捕获原始标记中定义的父项-子项关系：*HTML* 对象是 *body* 对象的父项，*body* 是 *paragraph* 对象的父项，依此类推。

![DOM æ ](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/images/dom-tree.png)

**整个流程的最终输出是我们这个简单页面的文档对象模型 (DOM)**

#### CSS对象模型（CSSOM）

在浏览器构建页面的 DOM 时，在文档的 head 部分遇到了一个 link 标记，该标记引用一个外部 CSS 样式表：style.css。由于预见到需要利用该资源来渲染页面，它会立即发出对该资源的请求。

![CSSOM æå"ºæ­¥éª¤](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/images/cssom-construction.png)

构建过程和DOM类似，先将字节转换成字符，接着令牌化，在转换成节点，最后构建CSSOM，比如

![CSSOM æ ](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/images/cssom-tree.png)

**树结构**

为页面上的任何对象计算最后一组样式时，浏览器都会先从适用于该节点的最通用规则开始（例如，如果该节点是 body 元素的子项，则应用所有 body 样式），然后通过应用更具体的规则（即规则“向下级联”）以递归方式优化计算的样式。每个浏览器都有默认样式，上面的树没包含

#### 构建渲染树/布局/绘制

CSSOM树和DOM树合并生成渲染树，接着计算每个可见元素的布局，并输出绘制的流程，最后将像素渲染到屏幕上。

**构建渲染树**

浏览器将 DOM 和 CSSOM 合并成一个“渲染树”，网罗网页上所有可见的 DOM 内容，以及每个节点的所有 CSSOM 样式信息。

- 从DOM树的根节点开始遍历每一个可见节点
  - 某些不可见的节点会被忽略，不会出现在渲染输出中（脚本标记/元标记）
  - css隐藏的节点也会被忽略
- 对于可见的节点，为其找到cssom树中的规则并且应用
- 输出可见的节点，连同其内容和计算的样式

渲染树构建完毕之后，就可以进行布局了

**布局阶段（自动重排）**

计算节点在设备视口内的确切位置和大小，浏览器从渲染树的根节点进行遍历

布局流程的输出是一个盒模型，它会精确地捕获每个元素在视口内的确切位置和尺寸：所有相对测量值都转换为屏幕上的绝对像素。

**绘制（栅格化）**

将渲染树中的节点转换成屏幕上的像素

> 执行渲染树构建、布局和绘制所需的时间将取决于文档大小、应用的样式，以及运行文档的设备：文档越大，浏览器需要完成的工作就越多；样式越复杂，绘制需要的时间就越长（例如，单色的绘制开销“较小”，而阴影的计算和渲染开销则要“大得多”）。

### 阻塞渲染的CSS

- 默认情况下，css被作为阻塞渲染的资源
- 可以通过媒体类型和媒体查询将一些 CSS 资源标记为不阻塞渲染。
- 浏览器会下载所有css资源，不论阻塞还是不阻塞

**CSS 是阻塞渲染的资源。需要将它尽早、尽快地下载到客户端，以便缩短首次渲染的时间。**

可以通过 CSS“媒体类型”和“媒体查询”来解决这类用例：

```css
<link href="print.css" rel="stylesheet" media="print"> //不阻塞。只在打印时阻塞
<link href="portrait.css" rel="stylesheet" media="orientation:portrait"> //根据网页加载时设备的方向
```

### JavaScript

JavaScript 允许我们修改网页的方方面面：内容、样式以及它如何响应用户交互。 不过，JavaScript 也会阻止 DOM 构建和延缓网页渲染。

- JavaScript 可以查询和修改 DOM 与 CSSOM。
- JavaScript 执行会阻止 CSSOM。
- 除非将 JavaScript 显式声明为异步，否则它会阻止构建 DOM。

脚本在文档的何处插入，就在何处执行。**执行我们的内联脚本会阻止 DOM 构建，也就延缓了首次渲染。**

简言之，JavaScript 在 DOM、CSSOM 和 JavaScript 执行之间引入了大量新的依赖关系，从而可能导致浏览器在处理以及在屏幕上渲染网页时出现大幅延迟：

- 脚本在文档中的位置很重要。
- 当浏览器遇到一个 script 标记时，DOM 构建将暂停，直至脚本完成执行。
- JavaScript 可以查询和修改 DOM 与 CSSOM。
- JavaScript 执行将暂停，直至 CSSOM 就绪。

“优化关键渲染路径”在很大程度上是指了解和优化 HTML、CSS 和 JavaScript 之间的依赖关系谱。

无论使用 <script> 标记还是内联 JavaScript 代码段，浏览器都会先暂停并执行脚本，然后才会处理剩余文档。不过，**如果是外部 JavaScript 文件，浏览器必须停下来，等待从磁盘、缓存或远程服务器获取脚本，这就可能给关键渲染路径增加数十至数千毫秒的延迟。**

**可以将脚本标记为异步**



了解了相关流程，我们可以看看上面的问题了

请注意这句话

**如果 DOM 或 CSSOM 被修改，您只能再执行一遍以上所有步骤，以确定哪些像素需要在屏幕上进行重新渲染。**

在考虑一个问题，我们都知道，在解析html的时候，浏览器会发起文档中所有的请求，如果不阻塞，我们举个极端例子，如果因为一些特殊原因，css的请求刚好在布局以后回来，而巧的是，我们每个节点都分了一个css文件,那这就导致了我们的浏览器快要累死了，一直在重复同一个操作。所以css阻塞渲染是有必要的。

### 优化关键渲染路径

为尽快完成首次渲染，我们需要最大限度减小以下三种可变因素：

- 关键资源的数量。
- 关键路径长度。
- 关键字节的数量。

1. 对关键路径进行分析和特性描述：资源数、字节数、长度。
2. 最大限度减少关键资源的数量：删除它们，延迟它们的下载，将它们标记为异步等。
3. 优化关键字节数以缩短下载时间（往返次数）。
4. 优化其余关键资源的加载顺序：您需要尽早下载所有关键资产，以缩短关键路径长度。

### 总结

**消除阻塞渲染的 JavaScript 和 CSS**

要以最快速度完成首次渲染，需要最大限度减少网页上关键资源的数量并（尽可能）消除这些资源，最大限度减少下载的关键字节数，以及优化关键路径长度。

**优化 JavaScript 的使用**

默认情况下，JavaScript 资源会阻塞解析器，除非将其标记为 `async` 或通过专门的 JavaScript 代码段进行添加。阻塞解析器的 JavaScript 会强制浏览器等待 CSSOM 并暂停 DOM 的构建，继而大大延迟首次渲染的时间。

**首选使用异步 JavaScript 资源**

异步资源不会阻塞文档解析器，让浏览器能够避免在执行脚本之前受阻于 CSSOM。通常，如果脚本可以使用 `async` 属性，也就意味着它并非首次渲染所必需。可以考虑在首次渲染后异步加载脚本。

**延迟解析 JavaScript**

为了最大限度减少浏览器渲染网页的工作量，应延迟任何非必需的脚本（即对构建首次渲染的可见内容无关紧要的脚本）。

**避免运行时间长的 JavaScript**

运行时间长的 JavaScript 会阻止浏览器构建 DOM、CSSOM 以及渲染网页，所以任何对首次渲染无关紧要的初始化逻辑和功能都应延后执行。如果需要运行较长的初始化序列，请考虑将其拆分为若干阶段，以便浏览器可以间隔处理其他事件。

**优化 CSS 的使用**

CSS 是构建渲染树的必备元素，首次构建网页时，JavaScript 常常受阻于 CSS。确保将任何非必需的 CSS 都标记为非关键资源（例如打印和其他媒体查询），并应确保尽可能减少关键 CSS 的数量，以及尽可能缩短传送时间。

**将 CSS 置于文档 head 标签内**

尽早在 HTML 文档内指定所有 CSS 资源，以便浏览器尽早发现 `<link>` 标记并尽早发出 CSS 请求。

**避免使用 CSS import**

一个样式表可以使用 CSS import (`@import`) 指令从另一样式表文件导入规则。不过，应避免使用这些指令，因为它们会在关键路径中增加往返次数：只有在收到并解析完带有 `@import` 规则的 CSS 样式表之后，才会发现导入的 CSS 资源。

**内联阻塞渲染的 CSS**

为获得最佳性能，您可能会考虑将关键 CSS 直接内联到 HTML 文档内。这样做不会增加关键路径中的往返次数，并且如果实现得当，在只有 HTML 是阻塞渲染的资源时，可实现“一次往返”关键路径长度。

### 解决问题

白屏有可能是在等待css或者js资源，

git 裸奔的情况就是因为css加载失败（一直没注意过，在看到这个问题去看了一下，果然是加载失败了），

[参考](<https://developers.google.com/web/fundamentals/performance/critical-rendering-path/>)